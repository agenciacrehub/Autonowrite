{% extends "base.html" %}

{% block title %}{{ title }} - AutonoWrite{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <a href="{{ url_for('projects.list_projects') }}" class="text-decoration-none text-gray-800">
                <i class="fas fa-arrow-left me-2"></i>{{ title }}
            </a>
        </h1>
        <div>
            {% if project %}
                <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i> Cancelar
                </a>
            {% else %}
                <a href="{{ url_for('projects.list_projects') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i> Cancelar
                </a>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Informações Básicas</h6>
                </div>
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="form-group">
                                    {{ form.title.label(class="form-label") }}
                                    {{ form.title(class="form-control" + (' is-invalid' if form.title.errors else ''), 
                                               placeholder="Nome do projeto") }}
                                    <div class="invalid-feedback">
                                        {{ form.title.errors[0] if form.title.errors else 'Por favor, insira um título para o projeto.' }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {{ form.status.label(class="form-label") }}
                                    {{ form.status(class="form-select" + (' is-invalid' if form.status.errors else '')) }}
                                    <div class="invalid-feedback">
                                        {{ form.status.errors[0] if form.status.errors }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mb-4">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control" + (' is-invalid' if form.description.errors else ''), 
                                             rows="4",
                                             placeholder="Descreva o propósito e os objetivos deste projeto") }}
                            <div class="form-text">
                                Esta descrição ajudará você e outras pessoas a entenderem o propósito deste projeto.
                            </div>
                            <div class="invalid-feedback">
                                {{ form.description.errors[0] if form.description.errors }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-4">
                                    {{ form.language.label(class="form-label") }}
                                    {{ form.language(class="form-select" + (' is-invalid' if form.language.errors else '')) }}
                                    <div class="invalid-feedback">
                                        {{ form.language.errors[0] if form.language.errors }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-4">
                                    {{ form.visibility.label(class="form-label") }}
                                    {{ form.visibility(class="form-select" + (' is-invalid' if form.visibility.errors else '')) }}
                                    <div class="form-text">
                                        {% if form.visibility.data == 'private' %}
                                            <i class="fas fa-lock me-1"></i> Apenas você pode ver e editar este projeto.
                                        {% elif form.visibility.data == 'team' %}
                                            <i class="fas fa-users me-1"></i> Membros da sua equipe podem ver e editar este projeto.
                                        {% else %}
                                            <i class="fas fa-globe me-1"></i> Qualquer pessoa com o link pode ver este projeto.
                                        {% endif %}
                                    </div>
                                    <div class="invalid-feedback">
                                        {{ form.visibility.errors[0] if form.visibility.errors }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="d-flex justify-content-between">
                            <div>
                                {% if project %}
                                    <a href="#" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteProjectModal">
                                        <i class="fas fa-trash-alt me-1"></i> Excluir Projeto
                                    </a>
                                {% endif %}
                            </div>
                            <div>
                                {{ form.submit(class="btn btn-primary") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            {% if project %}
                <!-- Project Activity -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Atividade Recente</h6>
                    </div>
                    <div class="card-body">
                        {% if project.executions %}
                            <div class="timeline">
                                {% for execution in project.executions.order_by(Execution.started_at.desc()).limit(5).all() %}
                                    <div class="timeline-item">
                                        <div class="timeline-marker">
                                            <div class="timeline-dot bg-{{ 'success' if execution.status.name == 'COMPLETED' else 'danger' if execution.status.name == 'FAILED' else 'primary' }}">
                                                <i class="fas fa-{{ 'check' if execution.status.name == 'COMPLETED' else 'times' if execution.status.name == 'FAILED' else 'play' }}"></i>
                                            </div>
                                        </div>
                                        <div class="timeline-content">
                                            <div class="d-flex justify-content-between">
                                                <h6 class="mb-1">
                                                    {% if execution.status.name == 'COMPLETED' %}
                                                        Execução concluída com sucesso
                                                    {% elif execution.status.name == 'FAILED' %}
                                                        Falha na execução
                                                    {% else %}
                                                        Execução em andamento
                                                    {% endif %}
                                                </h6>
                                                <small class="text-muted">{{ execution.started_at|timesince }}</small>
                                            </div>
                                            <p class="mb-0 text-muted">
                                                {% if execution.logs %}
                                                    {{ execution.logs[-1].message|truncate(100) }}
                                                {% else %}
                                                    Nenhum log disponível
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="text-center mt-3">
                                <a href="{{ url_for('execution.project_executions', project_id=project.id) }}" class="btn btn-sm btn-outline-primary">
                                    Ver histórico completo
                                </a>
                            </div>
                        {% else %}
                            <div class="text-center py-3">
                                <i class="fas fa-inbox fa-3x text-gray-300 mb-3"></i>
                                <p class="text-muted">Nenhuma atividade registrada ainda.</p>
                                <a href="{{ url_for('execution.execution_dashboard', project_id=project.id) }}" class="btn btn-primary">
                                    <i class="fas fa-play me-1"></i> Iniciar Primeira Execução
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Tips & Guidelines -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Dicas</h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb me-2"></i> Dicas para um bom título</h6>
                        <ul class="mb-0 ps-3">
                            <li>Seja claro e descritivo</li>
                            <li>Inclua palavras-chave relevantes</li>
                            <li>Mantenha-o curto e objetivo</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i> Configurações de visibilidade</h6>
                        <p class="mb-0">
                            Ajuste quem pode ver e editar este projeto. 
                            <strong>Projetos públicos</strong> podem ser vistos por qualquer pessoa com o link.
                        </p>
                    </div>
                    
                    {% if project %}
                        <div class="alert alert-secondary">
                            <h6><i class="fas fa-history me-2"></i> Histórico de alterações</h6>
                            <p class="mb-0">
                                Última atualização em <strong>{{ project.updated_at.strftime('%d/%m/%Y %H:%M') }}</strong>
                                {% if project.created_at != project.updated_at %}
                                    <br>
                                    <small class="text-muted">Criado em {{ project.created_at.strftime('%d/%m/%Y') }}</small>
                                {% endif %}
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Ações Rápidas</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if project %}
                            <a href="{{ url_for('execution.execution_dashboard', project_id=project.id) }}" class="btn btn-primary mb-2">
                                <i class="fas fa-play me-1"></i> Iniciar Execução
                            </a>
                            <a href="{{ url_for('projects.export_project', project_id=project.id) }}" class="btn btn-outline-secondary mb-2">
                                <i class="fas fa-download me-1"></i> Exportar Projeto
                            </a>
                            <a href="{{ url_for('projects.project_settings', project_id=project.id) }}" class="btn btn-outline-secondary mb-2">
                                <i class="fas fa-cog me-1"></i> Configurações Avançadas
                            </a>
                        {% else %}
                            <button type="button" class="btn btn-primary mb-2" disabled>
                                <i class="fas fa-save me-1"></i> Salve o projeto para desbloquear ações
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if project %}
<!-- Delete Project Modal -->
<div class="modal fade" id="deleteProjectModal" tabindex="-1" aria-labelledby="deleteProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteProjectModalLabel">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o projeto <strong>{{ project.title }}</strong>?</p>
                <p class="text-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i> 
                    Esta ação não pode ser desfeita e todos os dados do projeto serão permanentemente removidos.
                </p>
                <p class="mb-0">
                    <strong>Isso inclui:</strong>
                </p>
                <ul>
                    <li>Todas as execuções e seus logs</li>
                    <li>Qualquer conteúdo gerado</li>
                    <li>Configurações personalizadas</li>
                </ul>
                <p class="mb-0">
                    <strong>Total de execuções que serão removidas:</strong> {{ project.executions|length }}
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form action="{{ url_for('projects.delete_project', project_id=project.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-1"></i> Sim, Excluir Projeto
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Habilita a validação de formulário do Bootstrap
(function () {
    'use strict'
    
    // Busca todos os formulários que queremos aplicar estilos de validação personalizados
    var forms = document.querySelectorAll('.nexds-validation')
    
    // Loop sobre eles e evita o envio
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
            }
            
            form.classList.add('was-validated')
        }, false)
    })
})()

// Atualiza a dica de visibilidade quando o valor muda
document.getElementById('visibility').addEventListener('change', function() {
    const visibilityText = document.querySelector('.form-text')
    const icon = visibilityText.querySelector('i')
    
    switch(this.value) {
        case 'private':
            icon.className = 'fas fa-lock me-1'
            visibilityText.textContent = ' Apenas você pode ver e editar este projeto.'
            break
        case 'team':
            icon.className = 'fas fa-users me-1'
            visibilityText.textContent = ' Membros da sua equipe podem ver e editar este projeto.'
            break
        case 'public':
            icon.className = 'fas fa-globe me-1'
            visibilityText.textContent = ' Qualquer pessoa com o link pode ver este projeto.'
            break
    }
})
</script>

<style>
.timeline {
    position: relative;
    padding-left: 20px;
    margin: 0;
    list-style: none;
}

.timeline:before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: 5px;
    width: 2px;
    margin-left: -1.5px;
    background-color: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
    padding-left: 20px;
}

.timeline-marker {
    position: absolute;
    left: -20px;
    width: 20px;
    text-align: center;
}

.timeline-dot {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    color: white;
}

.timeline-content {
    padding: 0 0 1rem 0;
    border-bottom: 1px solid #e9ecef;
}

.timeline-item:last-child .timeline-content {
    border-bottom: none;
}

.bg-success {
    background-color: #1cc88a !important;
}

.bg-primary {
    background-color: #4e73df !important;
}

.bg-danger {
    background-color: #e74a3b !important;
}

.was-validated .form-control:invalid, .form-control.is-invalid {
    border-color: #e74a3b;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23e74a3b'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23e74a3b' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.was-validated .form-control:valid, .form-control.is-valid {
    border-color: #1cc88a;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%231cc88a' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.invalid-feedback {
    display: none;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #e74a3b;
}

.was-validated .form-control:invalid ~ .invalid-feedback,
.was-validated .form-control:invalid ~ .invalid-tooltip,
.form-control.is-invalid ~ .invalid-feedback,
.form-control.is-invalid ~ .invalid-tooltip {
    display: block;
}
</style>
{% endblock %}
